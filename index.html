<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: space-between;
            padding: 20px;
        }
        #scanner-container {
            width: 50%;
            border: 1px solid #ccc;
            padding: 10px;
        }
        #scanner-container video {
            width: 100%;
            height: auto;
        }
        #manual-input {
            margin-top: 10px;
            padding: 5px;
            width: 100%;
        }
        #attendance-list {
            width: 40%;
            border: 1px solid #ccc;
            padding: 10px;
        }
        #attendance-list h2 {
            margin-top: 0;
        }
        .attendance-item {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .attendance-item strong {
            display: block;
        }
        .attendance-item small {
            color: #666;
        }
    </style>
</head>
<body>
    <div id="scanner-container">
        <h2>Scanner</h2>
        <video id="video" autoplay></video>
        <canvas id="canvas" style="display: none;"></canvas>
        <input type="text" id="manual-input" placeholder="Manual Student Number (e.g., 25-0350)">
    </div>
    <div id="attendance-list">
        <h2>Attendance List</h2>
        <div id="list"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script>
        // Predefined student data (student number to name mapping)
        const students = {
            "25-0350": "Christopher I. Madamba",
            "12-0456": "Jane Doe",  // Example additions
            "34-0789": "John Smith"
        };

        // Array to hold attendance records (in-memory only)
        let attendance = [];
        const scannedSet = new Set(); // Prevent duplicates in session

        // Function to update the attendance list display
        function updateAttendanceList() {
            const listElement = document.getElementById('list');
            listElement.innerHTML = '';
            attendance.forEach(record => {
                const item = document.createElement('div');
                item.className = 'attendance-item';
                item.innerHTML = `
                    <strong>${record.name} (ID: ${record.studentNumber})</strong>
                    <small>Scanned at: ${record.timestamp}</small>
                `;
                listElement.appendChild(item);
            });
        }

        // Manual input handler for testing
        document.getElementById('manual-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const code = this.value.trim();
                if (students[code]) {
                    addToAttendance(code);
                    this.value = ''; // Clear input
                } else {
                    alert('Unknown student number.');
                }
            }
        });

        // Function to add to attendance (with duplicate check)
        function addToAttendance(studentNumber) {
            if (scannedSet.has(studentNumber)) return; // Skip duplicates
            scannedSet.add(studentNumber);
            const now = new Date();
            const timestamp = now.toLocaleString();
            attendance.push({
                studentNumber: studentNumber,
                name: students[studentNumber],
                timestamp: timestamp
            });
            updateAttendanceList();
            console.log(`Added: ${students[studentNumber]} (${studentNumber}) at ${timestamp}`);
        }

        // Initialize camera and QuaggaJS
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.play();

                // Initialize QuaggaJS for barcode scanning
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: video,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment"
                        }
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    numOfWorkers: 2,
                    decoder: {
                        readers: ["code_128_reader", "ean_reader", "upc_reader", "code_39_reader"] // More barcode types
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    Quagga.start();
                });

                // On barcode detection
                Quagga.onDetected(function(result) {
                    const code = result.codeResult.code;
                    if (students[code]) {
                        addToAttendance(code);
                    } else {
                        console.log(`Unknown barcode: ${code}`);
                    }
                });

                // OCR fallback: Scan for plain numbers every 2 seconds
                setInterval(() => {
                    const canvas = document.getElementById('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0);
                    Tesseract.recognize(canvas, 'eng', { logger: m => console.log(m) })
                        .then(({ data: { text } }) => {
                            // Extract numbers with possible hyphens (e.g., 25-0350)
                            const matches = text.match(/\d{2}-\d{4}|\d+/g);
                            if (matches) {
                                matches.forEach(match => {
                                    if (students[match]) {
                                        addToAttendance(match);
                                    }
                                });
                            }
                        })
                        .catch(err => console.error('OCR Error:', err));
                }, 2000); // Run every 2 seconds
            })
            .catch(err => {
                console.error('Error accessing camera:', err);
                alert('Camera access denied or not available.');
            });
    </script>
</body>
</html>
